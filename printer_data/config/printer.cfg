# ==============================
# Ender 3 V3 SE Upgraded CFG
# KE Hotend + Y-axis linear rails
# ==============================

[stepper_x]
step_pin: PA1
dir_pin: !PA2
enable_pin: !PA3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC0
position_endstop: 0      # REQUIRED → tells Klipper where X=0 is
position_min: 0
position_max: 220        # bed size
homing_speed: 50

[stepper_y]
step_pin: PB1
dir_pin: PB2
enable_pin: !PB3
step_distance: 0.0125
endstop_pin: ^PC1
position_min: 0
position_max: 220
homing_speed: 50

[stepper_z]
step_pin: PC1
dir_pin: !PC2
enable_pin: !PC3
step_distance: 0.0025
endstop_pin: ^PC4
position_min: 0
position_max: 250
homing_speed: 10

[extruder]
step_pin: PD1
dir_pin: !PD2
enable_pin: !PD3
step_distance: 0.0105  # tune after E-step calibration
nozzle_diameter: 0.4
filament_diameter: 1.75
max_extrude_only_distance: 100
heater_pin: PE0
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA4
control: pid
pid_Kp: 21.0   # tune with PID calibration
pid_Ki: 1.1
pid_Kd: 108.0
min_temp: 0
max_temp: 260

[heater_bed]
heater_pin: PE1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA5
control: pid
pid_Kp: 69.0  # tune with M303
pid_Ki: 1.5
pid_Kd: 480
min_temp: 0
max_temp: 120

[fan]
pin: PE2

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 250             # travel speed mm/s
max_accel: 3000               # mm/s²
max_z_velocity: 20
max_z_accel: 50

[virtual_sdcard]
path: /home/dave/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[homing_override]
set_position_z: 0
axes: z
gcode:
    G90
    G1 Z10 F600         ; move Z up a bit
    G28 X Y             ; home X and Y
    G1 X110 Y110 F6000  ; move to bed center (adjust to your bed size)
    G28 Z               ; home Z using probe

[bed_mesh]
speed: 100
horizontal_move_z: 5
mesh_min: 0,0
mesh_max: 220,220
probe_count: 5,5
fade_start: 1
fade_end: 10
fade_target: 0

[probe]
pin: PC5
x_offset: -44
y_offset: -9
z_offset: 1.8   # tune this with G28 + G1 Z0 test
speed: 5

[stepper_motor]
microsteps: 16

[motion]
# Linear Advance / Pressure Advance
pressure_advance: 0.06  # tune with test print
pressure_advance_lookahead_time: 0.010

[display]
lcd_type: ssd1306
i2c_bus: i2c1b
menu_timeout: 30

[e3v3se_display]
language: english
logging: True


[include mainsail.cfg]